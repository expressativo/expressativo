<div data-controller="task-status">
  <% boards = @project.boards.includes(:columns) %>
  
  <% if boards.any? %>
    <div class="space-y-2">      
      <div class="relative">
        <% if task.column.present? %>
          <!-- Mostrar estatus actual con opción de editar -->
          <button 
            type="button"
            data-action="click->task-status#toggleDropdown"
            data-task-status-target="button"
            class="w-full flex items-center justify-between px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div>
              <div class="text-sm font-medium text-gray-900">
                <%= task.column.title %>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-600" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M6 9l6 6l6 -6" />
              </svg>
            </div>
          </button>
        <% else %>
          <!-- Selector cuando no hay estatus -->
          <button 
            type="button"
            data-action="click->task-status#toggleDropdown"
            data-task-status-target="button"
            class="w-full flex items-center justify-between px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span data-task-status-target="selectedText" class="text-gray-500">
              Seleccionar estatus
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M6 9l6 6l6 -6" />
            </svg>
          </button>
        <% end %>
        
        <!-- Dropdown con todas las opciones -->
        <div 
          data-task-status-target="dropdown"
          class="hidden absolute z-[9999] w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto">
          <% boards.each do |board| %>
            <div class="p-2 border-b border-gray-100">
              <div class="text-xs font-semibold text-gray-500 uppercase px-2 py-1">
                <%= board.title %>
              </div>
              <% board.columns.each do |column| %>
                <button
                  type="button"
                  data-action="click->task-status#selectColumn"
                  data-column-id="<%= column.id %>"
                  data-column-title="<%= column.title %>"
                  data-board-title="<%= board.title %>"
                  class="w-full text-left px-3 py-2 hover:bg-blue-50 rounded text-sm <%= 'bg-blue-100 font-medium' if task.column&.id == column.id %>">
                  <%= column.title %>
                  <% if task.column&.id == column.id %>
                    <span class="text-xs text-blue-600 ml-1">✓</span>
                  <% end %>
                </button>
              <% end %>
            </div>
          <% end %>
          
          <!-- Opción para quitar estatus -->
          <% if task.column.present? %>
            <div class="p-2 border-t border-gray-200">
              <button
                type="button"
                data-action="click->task-status#clearStatus"
                class="w-full text-left px-3 py-2 text-red-600 hover:bg-red-50 rounded text-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M18 6l-12 12" />
                  <path d="M6 6l12 12" />
                </svg>
                Quitar estatus
              </button>
            </div>
          <% end %>
        </div>
        
        <%= form.hidden_field :column_id, data: { task_status_target: "columnInput" } %>
      </div>
      
      <% if task.column.blank? %>
        <p class="text-xs text-gray-500 mt-1">
          El estatus determina en qué columna del tablero Kanban aparecerá esta tarea
        </p>
      <% end %>
    </div>
  <% end %>
</div>
